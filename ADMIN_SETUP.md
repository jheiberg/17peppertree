# Admin Portal Setup Guide

## Overview
The 17 @ Peppertree Admin Portal provides a secure interface for managing bookings and payments. It uses Keycloak for OAuth2 authentication and includes features for booking approval, payment tracking, and guest communication.

## Quick Start

### 1. Start Services with Keycloak
```bash
# Start all services including Keycloak
docker compose -f docker-compose.keycloak.yml up -d

# Check that all services are running
docker compose -f docker-compose.keycloak.yml ps
```

### 2. Configure Keycloak
```bash
# Make the setup script executable
chmod +x setup-keycloak.sh

# Run the setup script
./setup-keycloak.sh
```

The script will:
- Wait for Keycloak to be ready
- Create the 'peppertree' realm
- Configure the admin client
- Create an admin user
- Generate secure credentials

### 3. Apply Database Migrations
```bash
# Connect to the database
docker exec -it peppertree_db psql -U postgres -d peppertree

# Run the migration
\i /migrations/add_admin_fields.sql

# Exit
\q
```

### 4. Configure Environment Variables
Add the following to your `.env` file:
```env
# From .env.keycloak generated by setup script
KEYCLOAK_CLIENT_SECRET=<generated-secret>

# Email configuration (required for notifications)
MAIL_USERNAME=your-email@gmail.com
MAIL_PASSWORD=your-app-password
MAIL_DEFAULT_SENDER=your-email@gmail.com
OWNER_EMAIL=owner@example.com
```

### 5. Install Frontend Dependencies
```bash
npm install
```

## Access the Admin Portal

### Admin URL
Navigate to: `http://localhost:3000/admin`

### Default Credentials
- **Username**: admin
- **Password**: (provided by setup script)
- **Important**: You will be prompted to change the password on first login

## Features

### Dashboard
- Overview of booking statistics
- Recent bookings list
- Payment status summary
- Total revenue tracking

### Booking Management
- View all bookings with filtering options
- Approve or reject booking requests
- Add admin notes
- Send email notifications to guests

### Payment Tracking
- Update payment status
- Record payment amounts and references
- Track payment methods
- Generate payment reports

## Security

### Authentication Flow
1. User accesses `/admin`
2. Redirected to Keycloak login if not authenticated
3. After successful login, redirected back to admin portal
4. JWT token used for API authentication

### Role-Based Access
- `admin`: Full system access
- `peppertree-admin`: Property management access

## Troubleshooting

### Keycloak Issues
```bash
# Check Keycloak logs
docker logs peppertree_keycloak

# Restart Keycloak
docker restart peppertree_keycloak

# Access Keycloak admin console
# URL: http://localhost:8080/admin
# Username: admin
# Password: admin_password
```

### Database Issues
```bash
# Check database logs
docker logs peppertree_db

# Connect to database manually
docker exec -it peppertree_db psql -U postgres -d peppertree

# List tables
\dt

# Check booking_requests structure
\d booking_requests
```

### Frontend Issues
```bash
# Clear npm cache
npm cache clean --force

# Reinstall dependencies
rm -rf node_modules package-lock.json
npm install

# Check for port conflicts
lsof -i :3000
```

## API Endpoints

### Admin Endpoints (Protected)
- `GET /api/admin/bookings` - List all bookings
- `GET /api/admin/booking/{id}` - Get booking details
- `PUT /api/admin/booking/{id}/status` - Update booking status
- `PUT /api/admin/booking/{id}/payment` - Update payment info
- `DELETE /api/admin/booking/{id}` - Soft delete booking
- `GET /api/admin/dashboard/stats` - Get dashboard statistics

### Authentication Endpoints
- `GET /api/auth/login` - Initiate OAuth2 flow
- `POST /api/auth/callback` - Handle OAuth2 callback
- `POST /api/auth/refresh` - Refresh access token
- `POST /api/auth/logout` - Logout user
- `GET /api/auth/user` - Get current user info

## Development

### Running Locally
```bash
# Backend
cd backend
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
python app.py

# Frontend
npm start
```

### Adding New Admin Users
1. Access Keycloak admin console
2. Navigate to Users in the peppertree realm
3. Click "Add user"
4. Set username, email, and temporary password
5. After creation, go to "Role Mappings"
6. Assign "peppertree-admin" role

## Production Deployment

### Security Checklist
- [ ] Change all default passwords
- [ ] Generate new client secret
- [ ] Update CORS origins in backend
- [ ] Configure SSL/TLS certificates
- [ ] Set secure session secrets
- [ ] Enable rate limiting
- [ ] Configure backup strategy
- [ ] Set up monitoring

### Environment Variables
```env
# Production settings
FLASK_ENV=production
KEYCLOAK_SERVER_URL=https://auth.yourdomain.com
REACT_APP_API_URL=https://api.yourdomain.com
REACT_APP_KEYCLOAK_URL=https://auth.yourdomain.com
```

## Support
For issues or questions about the admin portal, please check the logs first and ensure all services are running correctly.