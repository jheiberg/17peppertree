<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .info { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffdddd; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #ddffdd; padding: 10px; margin: 10px 0; border-radius: 5px; }
        button { padding: 10px 20px; margin: 10px 0; font-size: 16px; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <h1>Keycloak Auth Diagnostic</h1>
    
    <div id="output"></div>
    
    <button onclick="testAuth()">Test Authentication</button>
    
    <script>
        const output = document.getElementById('output');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            output.appendChild(div);
        }
        
        async function testAuth() {
            output.innerHTML = '';
            
            // Check environment
            log(`Current URL: ${window.location.href}`);
            log(`Current Origin: ${window.location.origin}`);
            
            // Check Web Crypto API
            if (window.crypto && window.crypto.subtle) {
                log('✓ Web Crypto API available', 'success');
            } else {
                log('✗ Web Crypto API NOT available (HTTP context)', 'error');
            }
            
            // Get config from environment
            const config = {
                url: 'http://192.168.1.222:8080',
                realm: 'peppertree',
                clientId: 'peppertree-admin',
                redirectUri: `${window.location.origin}/auth/callback`
            };
            
            log(`<pre>Config:\n${JSON.stringify(config, null, 2)}</pre>`);
            
            // Test Keycloak endpoint
            try {
                const response = await fetch(`${config.url}/realms/${config.realm}/.well-known/openid-configuration`);
                if (response.ok) {
                    log('✓ Keycloak endpoint reachable', 'success');
                    const data = await response.json();
                    log(`Authorization endpoint: ${data.authorization_endpoint}`);
                } else {
                    log(`✗ Keycloak returned status ${response.status}`, 'error');
                }
            } catch (error) {
                log(`✗ Cannot reach Keycloak: ${error.message}`, 'error');
            }
            
            // Build auth URL (simplified, no PKCE)
            const authParams = new URLSearchParams({
                client_id: config.clientId,
                redirect_uri: config.redirectUri,
                response_type: 'code',
                scope: 'openid profile email',
                state: 'test-state-' + Date.now()
            });
            
            const authUrl = `${config.url}/realms/${config.realm}/protocol/openid-connect/auth?${authParams}`;
            
            log(`<strong>Test Auth URL (without PKCE):</strong><br><a href="${authUrl}" target="_blank">Click to test</a>`);
            log(`<pre>${authUrl}</pre>`);
        }
    </script>
</body>
</html>
